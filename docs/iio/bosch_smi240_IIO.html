<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bosch SMI240 IIO driver &mdash; Bosch MEMS Sensor Linux Driver  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Bosch SMI330 IIO driver" href="bosch_smi330_IIO.html" />
    <link rel="prev" title="Bosch SMI230 IIO driver" href="bosch_smi230_IIO.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Bosch MEMS Sensor Linux Driver
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="bosch_smi230_IIO.html">Bosch SMI230 IIO driver</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Bosch SMI240 IIO driver</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">1. Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#hardware-setup">2. Hardware Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#hardware-components">2.1 Hardware Components:</a></li>
<li class="toctree-l3"><a class="reference internal" href="#jumpers-on-the-mother-board">2.2 Jumpers on the mother board</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cable-connection">2.3 Cable Connection</a></li>
<li class="toctree-l3"><a class="reference internal" href="#first-startup">2.4 First Startup</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#software-setup">3. Software Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#required-software">3.1 Required Software</a></li>
<li class="toctree-l3"><a class="reference internal" href="#build-smi240-iio-linux-driver">3.2 Build SMI240 IIO Linux driver</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#integrate-linux-driver-into-linux-kernel">Integrate Linux driver into Linux kernel</a></li>
<li class="toctree-l4"><a class="reference internal" href="#build-smi240-linux-driver-with-the-kernel">Build SMI240 Linux driver with the kernel</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#work-with-smi240-linux-driver">4. Work with SMI240 Linux driver</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#preparation">4.1 Preparation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#read-sensor-temperature">4.2 Read sensor temperature</a></li>
<li class="toctree-l3"><a class="reference internal" href="#read-accelerometer-value">4.3 Read accelerometer value</a></li>
<li class="toctree-l3"><a class="reference internal" href="#read-gyroscope-current-value">4.4 Read gyroscope current value</a></li>
<li class="toctree-l3"><a class="reference internal" href="#get-synchronized-accelerometer-gyroscope-and-temperature-value">4.5 Get synchronized accelerometer, gyroscope and temperature value</a></li>
<li class="toctree-l3"><a class="reference internal" href="#signal-filtering">4.6 Signal filtering</a></li>
<li class="toctree-l3"><a class="reference internal" href="#self-test">4.7 Self Test</a></li>
<li class="toctree-l3"><a class="reference internal" href="#soft-reset">4.8 Soft reset</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sign-of-channels">4.9 Sign of channels</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="bosch_smi330_IIO.html">Bosch SMI330 IIO driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hal/bosch_smi240_HAL.html">Bosch SMI240 Sensor HAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hal/bosch_MEMS-Android-HAL.html">Bosch MEMS Android HAL</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Bosch MEMS Sensor Linux Driver</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Bosch SMI240 IIO driver</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/iio/bosch_smi240_IIO.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="bosch-smi240-iio-driver">
<h1>Bosch SMI240 IIO driver<a class="headerlink" href="#bosch-smi240-iio-driver" title="Link to this heading"></a></h1>
<section id="overview">
<h2>1. Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h2>
<p>The driver is intended to work on Bosch SMI240 Inertial Measurement Unit for Non-Safety Automotive Applications.
The SMI240 is a combined three axis angular rate and three axis acceleration sensor module with a measurement range of +/-300°/s and up to 16g. SMI240 is a 6 DoF (Degrees of Freedom) sensor module providing acceleration and angular rate signals via a digital interface (SPI). The sensor consists of two Micro Electro Mechanical System (MEMS) elements and a sensor readoutASIC. The ASIC contains analogue front ends and a digital structure for signal processing and communication interface. The sensor module is available in a LGA (Land Grid Array) housing.</p>
</section>
<section id="hardware-setup">
<h2>2. Hardware Setup<a class="headerlink" href="#hardware-setup" title="Link to this heading"></a></h2>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>This Hardware Setup serves as a quick startup kit, to help the user to run and understand the driver. It is for demonstration purposes, not supposed to be used in a production environment.</p>
</div>
<section id="hardware-components">
<h3>2.1 Hardware Components:<a class="headerlink" href="#hardware-components" title="Link to this heading"></a></h3>
<ol class="arabic simple">
<li><p>Linux Host Board</p></li>
<li><p>SMI240 sensor + Shuttleboard + Motherboard (acquirable from Bosch)</p></li>
<li><p>connection cable (female to female)</p></li>
<li><p>A micro SD card (if required by the host board)</p></li>
</ol>
</section>
<section id="jumpers-on-the-mother-board">
<h3>2.2 Jumpers on the mother board<a class="headerlink" href="#jumpers-on-the-mother-board" title="Link to this heading"></a></h3>
<p>We need to change the default Jumpers.</p>
<ul class="simple">
<li><p>Remove the jumper “Connection VDDIO” and put this jumper to connect “VDD” and “VDDIO”</p></li>
</ul>
<p>Make sure that</p>
<ul class="simple">
<li><p>Both BUS_ID_0 and BUS_ID_1 are connected to GND</p></li>
</ul>
</section>
<section id="cable-connection">
<h3>2.3 Cable Connection<a class="headerlink" href="#cable-connection" title="Link to this heading"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> .................................                      .................................
.?^^^^^^^^^^~~~~~~~~^^^^^^^^^^^^^~?       VDD          !!^^^^^^^^^~~~~~~~~~~~~~~^^^^^^^^7~
:?          Host Board            Y~~~~~~~~~~~~~~~~~~~~J~ 1    SMI240 Mother Board      !!
:?                               .J      VDDIO         ?^                               !~
:?                               .Y~~~~~~~~~~~~~~~~~~~~J^ 2                             !~
:?                               .J                    7^                               !~
:?                               .J       GND          7^                               !~
:?                               .Y~~~~~~~~~~~~~~~~~~~~J~ 3                             !~
:?                               .J       MISO         ?^                               !~
:?                               .Y~~~~~~~~~~~~~~~~~~~~J~ 4                             !~
:?                               .Y       MOSI         J~                               !~
:?                               .J~~~~~~~~~~~~~~~~~~~~?~ 5                             !~
:?                               .Y       SLK          J~                               !~
:?                               .Y~~~~~~~~~~~~~~~~~~~~J~ 6                             !~
:?                               .J       CSB          7^                               !~
:?                               .J~~~~~~~~~~~~~~~~~~~~7^ 7                             !~
:?                               .J                    7^                               !~
:?                               .J                    7^                               !~
:?                               .J                    7^                      BUS_ID_0 !~~GND
:?                               .Y                    J^                               !~
:?                               .J                    ?^                      BUS_ID_1 !~~GND
:?                                Y                    J^                               !~
:J...............................:J                    7~...............................7~
 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^                    :^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^.
</pre></div>
</div>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>SMI240 Shuttle Pin</p></th>
<th class="head"><p>Function</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>VDD</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>VDD IO</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>GND</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>MISO</p></td>
</tr>
<tr class="row-even"><td><p>5</p></td>
<td><p>MOSI</p></td>
</tr>
<tr class="row-odd"><td><p>6</p></td>
<td><p>SCLK</p></td>
</tr>
<tr class="row-even"><td><p>7</p></td>
<td><p>CSB</p></td>
</tr>
</tbody>
</table>
</section>
<section id="first-startup">
<h3>2.4 First Startup<a class="headerlink" href="#first-startup" title="Link to this heading"></a></h3>
<ol class="arabic simple">
<li><p>Write Linux Image (32 bit) to SD Card</p></li>
<li><p>Insert SD Card Host Board and power on</p></li>
<li><p>Enable SSH on Host Board</p></li>
</ol>
</section>
</section>
<section id="software-setup">
<h2>3. Software Setup<a class="headerlink" href="#software-setup" title="Link to this heading"></a></h2>
<section id="required-software">
<h3>3.1 Required Software<a class="headerlink" href="#required-software" title="Link to this heading"></a></h3>
<ol class="arabic simple">
<li><p>Host Board Linux (kernel version 5.15)</p></li>
<li><p>SMI240 IIO Linux driver   <a class="reference external" href="https://github.com/boschmemssolutions/SMI240-Linux-Driver-IIO">https://github.com/boschmemssolutions/SMI240-Linux-Driver-IIO</a></p></li>
<li><p>Linux development environment (native or as VM)</p></li>
</ol>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Most board manufacturer provides customized Linux distribution for their boards. Consult with your board manufacturer. And download the Linux distribution for your board, if available.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We do not recommend to build the driver with Linux kernel directly on host board. This takes too long. Build it on PC is much faster. Since the toolchain is Linux based, a Linux environment is required. We use Ubuntu 20.04.1 LTS</p>
</div>
<ul class="simple">
<li><p>Install Toolchain and dependences</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">crossbuild</span><span class="o">-</span><span class="n">essential</span><span class="o">-</span><span class="n">armhf</span>
<span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">git</span> <span class="n">bc</span> <span class="n">bison</span> <span class="n">flex</span> <span class="n">libssl</span><span class="o">-</span><span class="n">dev</span> <span class="n">make</span> <span class="n">libc6</span><span class="o">-</span><span class="n">dev</span> <span class="n">libncurses5</span><span class="o">-</span><span class="n">dev</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Clone Linux kernel</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="o">--</span><span class="n">depth</span><span class="o">=</span><span class="mi">1</span> <span class="o">--</span><span class="n">branch</span> <span class="o">&lt;</span><span class="n">branch_name</span><span class="o">&gt;</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">raspberrypi</span><span class="o">/</span><span class="n">linux</span>
</pre></div>
</div>
<p>We use kernel v5.15, replace &lt;branch_name&gt; with “rpi-5.15.y”</p>
<ul class="simple">
<li><p>Clone SMI240 IIO Linux driver</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="o">--</span><span class="n">depth</span><span class="o">=</span><span class="mi">1</span>  <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">boschmemssolutions</span><span class="o">/</span><span class="n">SMI240</span><span class="o">-</span><span class="n">Linux</span><span class="o">-</span><span class="n">Driver</span><span class="o">-</span><span class="n">IIO</span><span class="o">.</span><span class="n">git</span>
</pre></div>
</div>
</section>
<section id="build-smi240-iio-linux-driver">
<h3>3.2 Build SMI240 IIO Linux driver<a class="headerlink" href="#build-smi240-iio-linux-driver" title="Link to this heading"></a></h3>
<section id="integrate-linux-driver-into-linux-kernel">
<h4>Integrate Linux driver into Linux kernel<a class="headerlink" href="#integrate-linux-driver-into-linux-kernel" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Copy source code into Linux kernel</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="o">/</span><span class="n">smi240</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">driver</span><span class="o">-</span><span class="n">iio</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">iio</span><span class="o">/</span><span class="n">imu</span><span class="o">/</span><span class="n">smi240</span> <span class="n">linux</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">iio</span><span class="o">/</span><span class="n">imu</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Add entry in imu Kconfig</p></li>
</ul>
<p>Open linux/drivers/iio/imu/Kconfig and add the SMI240 entry at bottom</p>
<div class="highlight-kconfig notranslate"><div class="highlight"><pre><span></span><span class="k">source</span><span class="w"> </span><span class="s2">&quot;drivers/iio/imu/.../Kconfig&quot;</span>
<span class="k">source</span><span class="w"> </span><span class="s2">&quot;drivers/iio/imu/smi240/Kconfig&quot;</span>
<span class="k">source</span><span class="w"> </span><span class="s2">&quot;drivers/iio/imu/.../Kconfig&quot;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Add entry in imu Makefile</p></li>
</ul>
<p>Open linux/drivers/iio/accel/Makefile and add the SMI240 entry at bottom</p>
<div class="highlight-makefile notranslate"><div class="highlight"><pre><span></span><span class="nv">obj-y</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span>smi240/
<span class="nv">obj-y</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span>s.../
</pre></div>
</div>
<ul class="simple">
<li><p>Add devicetree overlay</p></li>
</ul>
<p>Create a devicetree overlay file “smi240-spi-overlay.dts” with the following content, and put it under “linux/arch/arm/boot/dts/overlays”</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Dependent on your hardware plattform and pin layout, the settings may be diffrent and an adaption to your target system may be required.</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">dts</span><span class="o">-</span><span class="n">v1</span><span class="o">/</span><span class="p">;</span>
<span class="o">/</span><span class="n">plugin</span><span class="o">/</span><span class="p">;</span>

        <span class="o">/</span> <span class="p">{</span>
        <span class="n">compatible</span> <span class="o">=</span> <span class="s2">&quot;brcm,bcm2835&quot;</span><span class="p">;</span>

        <span class="n">fragment</span><span class="o">@</span><span class="mi">0</span> <span class="p">{</span>
                <span class="n">target</span> <span class="o">=</span> <span class="o">&lt;&amp;</span><span class="n">spidev0</span><span class="o">&gt;</span><span class="p">;</span>
                <span class="n">__dormant__</span> <span class="p">{</span>
                        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;disabled&quot;</span><span class="p">;</span>
                <span class="p">};</span>
        <span class="p">};</span>

        <span class="n">fragment</span><span class="o">@</span><span class="mi">1</span> <span class="p">{</span>
                <span class="n">target</span> <span class="o">=</span> <span class="o">&lt;&amp;</span><span class="n">spidev1</span><span class="o">&gt;</span><span class="p">;</span>
                <span class="n">__dormant__</span> <span class="p">{</span>
                        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;disabled&quot;</span><span class="p">;</span>
                <span class="p">};</span>
        <span class="p">};</span>

        <span class="n">fragment</span><span class="o">@</span><span class="mi">2</span> <span class="p">{</span>
                <span class="n">target</span> <span class="o">=</span> <span class="o">&lt;&amp;</span><span class="n">spi0</span><span class="o">&gt;</span><span class="p">;</span>
                <span class="n">__dormant__</span> <span class="p">{</span>
                        <span class="c1">#address-cells = &lt;1&gt;;</span>
                        <span class="c1">#size-cells = &lt;0&gt;;</span>
                        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;okay&quot;</span><span class="p">;</span>

                        <span class="n">smi240</span><span class="o">@</span><span class="mi">0</span> <span class="p">{</span>
                                <span class="n">compatible</span> <span class="o">=</span> <span class="s2">&quot;BOSCH,SMI240&quot;</span><span class="p">;</span>
                                <span class="n">spi</span><span class="o">-</span><span class="nb">max</span><span class="o">-</span><span class="n">frequency</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mi">10000000</span><span class="o">&gt;</span><span class="p">;</span>
                                <span class="n">reg</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span>
                        <span class="p">};</span>
                <span class="p">};</span>
        <span class="p">};</span>

        <span class="n">__overrides__</span> <span class="p">{</span>
                <span class="n">smi240</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span> <span class="s2">&quot;=0=2&quot;</span><span class="p">;</span>
        <span class="p">};</span>
<span class="p">};</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Add entry in devicetree overlay Makefile</p></li>
</ul>
<div class="highlight-makefile notranslate"><div class="highlight"><pre><span></span><span class="nv">dtbo-$(CONFIG_ARCH_BCM2835)</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>...<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>smi240-spi.dtbo<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>...<span class="w"> </span><span class="se">\</span>
</pre></div>
</div>
</section>
<section id="build-smi240-linux-driver-with-the-kernel">
<h4>Build SMI240 Linux driver with the kernel<a class="headerlink" href="#build-smi240-linux-driver-with-the-kernel" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Config SMI240 Linux driver</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">linux</span>
<span class="n">make</span> <span class="n">ARCH</span><span class="o">=</span><span class="n">arm</span> <span class="n">CROSS_COMPILE</span><span class="o">=</span><span class="n">arm</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnueabihf</span><span class="o">-</span> <span class="n">bcm2709_defconfig</span>
<span class="n">make</span> <span class="n">ARCH</span><span class="o">=</span><span class="n">arm</span> <span class="n">CROSS_COMPILE</span><span class="o">=</span><span class="n">arm</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnueabihf</span><span class="o">-</span> <span class="n">menuconfig</span>
</pre></div>
</div>
<p>Activate the options as following</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>To activate an option, press “y” on the option. A * appears, which means this option is activated as part of the kernel. Alternatively we can press “m” on the option. A “M” appears, which means this option is activated as kernel module (not as part of the kernel). Therefore we need to manually install the kernel module by ourself.</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Device</span> <span class="n">Drivers</span> <span class="o">--&gt;</span>
      <span class="o">&lt;*&gt;</span><span class="n">Industrial</span> <span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="n">support</span>  <span class="o">---&gt;</span>
              <span class="n">Inertial</span> <span class="n">measurement</span> <span class="n">units</span>  <span class="o">---&gt;</span>
                      <span class="o">&lt;*&gt;</span> <span class="n">Bosch</span> <span class="n">Sensor</span> <span class="n">SMI240</span> <span class="n">Inertial</span> <span class="n">Measurement</span> <span class="n">Unit</span>
                      <span class="p">(</span><span class="mi">1024</span><span class="p">)</span> <span class="n">configue</span> <span class="n">read</span> <span class="n">buffer</span> <span class="n">size</span> <span class="p">(</span><span class="n">NEW</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Build SMI240 Linux driver</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="o">-</span><span class="n">j4</span> <span class="n">ARCH</span><span class="o">=</span><span class="n">arm</span> <span class="n">CROSS_COMPILE</span><span class="o">=</span><span class="n">arm</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnueabihf</span><span class="o">-</span> <span class="n">zImage</span> <span class="n">modules</span> <span class="n">dtbs</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Build process takes quite long on the first time. To reduce the build time, we use the option “-j4”. This is the option to enable the build process to be executed parallelly in 4 threads. To improve the parallel execution, just give a big number e.g. “-j6”. How many parallel thread to use is dependent on your processor core number.</p>
</div>
<ul class="simple">
<li><p>Install the kernel with SMI240 Linux driver in SD card</p></li>
</ul>
<p>insert the SD card (created in 2.3). A “boot” partition and a “rootfs” partition will be mounted. Find out the mount point. In Ubuntu the mount point looks like that</p>
<blockquote>
<div><p>/media/username/boot</p>
<p>/media/username/rootfs</p>
</div></blockquote>
<p>write the kernel with SMI240 Linux driver in SD card</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>export KERNEL=kernel7
export SD_BOOT_PATH=/media/username/boot
export SD_ROOTFS_PATH=/media/username/rootfs
sudo env PATH=$PATH make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- INSTALL_MOD_PATH=$SD_ROOTFS_PATH modules_install
sudo cp $SD_BOOT_PATH/$KERNEL.img $SD_BOOT_PATH/$KERNEL-backup.img
sudo cp arch/arm/boot/zImage $SD_BOOT_PATH/$KERNEL.img
sudo cp arch/arm/boot/dts/*.dtb $SD_BOOT_PATH
sudo cp arch/arm/boot/dts/overlays/*.dtb* $SD_BOOT_PATH/overlays/
sudo cp arch/arm/boot/dts/overlays/README $SD_BOOT_PATH/overlays/
</pre></div>
</div>
<ul class="simple">
<li><p>adapt the boot configuraion</p></li>
</ul>
<p>open the “config.txt” in “boot” partition, and add the following entries</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Uncomment some or all of these to enable the optional hardware interfaces</span>
<span class="n">dtparam</span><span class="o">=</span><span class="n">spi</span><span class="o">=</span><span class="n">on</span>
<span class="n">dtoverlay</span><span class="o">=</span><span class="n">smi240</span><span class="o">-</span><span class="n">spi</span><span class="p">,</span><span class="n">smi240</span>
</pre></div>
</div>
<p>Take the SD card out and put it back in board.</p>
</section>
</section>
</section>
<section id="work-with-smi240-linux-driver">
<h2>4. Work with SMI240 Linux driver<a class="headerlink" href="#work-with-smi240-linux-driver" title="Link to this heading"></a></h2>
<section id="preparation">
<h3>4.1 Preparation<a class="headerlink" href="#preparation" title="Link to this heading"></a></h3>
<p>Power on the board. We firstly check if the driver was initialized properly</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dmesg</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">SMI240</span>
<span class="p">[</span>   <span class="mf">68.592919</span><span class="p">]</span> <span class="n">SMI240</span> <span class="n">Chip</span> <span class="n">ID</span><span class="p">:</span> <span class="mh">0x0024</span>
<span class="p">[</span>   <span class="mf">68.593345</span><span class="p">]</span> <span class="n">Bosch</span> <span class="n">Sensor</span> <span class="n">Device</span> <span class="n">SMI240</span> <span class="n">initialized</span>
</pre></div>
</div>
<p>If the driver was installed properly, a folder will be created. A number of devicefiles are created in the folders. which we can use to read/write data from/to the sensor</p>
<blockquote>
<div><p>/sys/bus/iio/devices/iio:device0</p>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Folder name is assigned automatically by the system, therefore does not reflect the sensor type. There is a “name” file in the devicefolder, that we can read to find out the sensor type</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">bus</span><span class="o">/</span><span class="n">iio</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">iio</span><span class="p">:</span><span class="n">device0</span>
<span class="n">cat</span> <span class="n">name</span>
<span class="n">SMI240</span>
</pre></div>
</div>
<p>Work with driver using command line</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To change sensor settings we need root access. It is not sufficient just using “sudo …” .</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">su</span>
</pre></div>
</div>
</section>
<section id="read-sensor-temperature">
<h3>4.2 Read sensor temperature<a class="headerlink" href="#read-sensor-temperature" title="Link to this heading"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="n">in_temp_object_raw</span>
<span class="mi">19</span>
</pre></div>
</div>
</section>
<section id="read-accelerometer-value">
<h3>4.3 Read accelerometer value<a class="headerlink" href="#read-accelerometer-value" title="Link to this heading"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="n">in_accel_x</span>\<span class="o">&amp;</span><span class="n">y</span>\<span class="o">&amp;</span><span class="n">z_raw</span>
<span class="mi">19</span> <span class="o">-</span><span class="mi">12</span> <span class="mi">1997</span>
<span class="p">[</span><span class="n">x</span>  <span class="n">y</span>   <span class="n">z</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="read-gyroscope-current-value">
<h3>4.4 Read gyroscope current value<a class="headerlink" href="#read-gyroscope-current-value" title="Link to this heading"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="n">in_anglvel_x</span>\<span class="o">&amp;</span><span class="n">y</span>\<span class="o">&amp;</span><span class="n">z_raw</span>
<span class="o">-</span><span class="mi">24</span> <span class="mi">21</span> <span class="o">-</span><span class="mi">15</span>
<span class="p">[</span><span class="n">x</span>  <span class="n">y</span>   <span class="n">z</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="get-synchronized-accelerometer-gyroscope-and-temperature-value">
<h3>4.5 Get synchronized accelerometer, gyroscope and temperature value<a class="headerlink" href="#get-synchronized-accelerometer-gyroscope-and-temperature-value" title="Link to this heading"></a></h3>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Synchronisation of sensor data is done by trigger and capture mechanism. Sensor measurement data and channel status of all channels (LF and HF) on one chip select line can be captured (stored sensor internally) at one point in time and read out at a later point in time</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="n">in_temp_accel_anglvel_capture</span>
<span class="mi">19</span> <span class="mi">38</span> <span class="o">-</span><span class="mi">14</span> <span class="mi">2029</span> <span class="o">-</span><span class="mi">4</span> <span class="o">-</span><span class="mi">17</span> <span class="o">-</span><span class="mi">3</span>
<span class="p">[</span><span class="n">temp</span> <span class="n">accX</span> <span class="n">accY</span> <span class="n">accZ</span> <span class="n">gyroX</span> <span class="n">gyroY</span> <span class="n">gyroZ</span><span class="p">]</span>
</pre></div>
</div>
<p>This triggers the data capture and read the synchronized accelerometer, gyroscope and temperature value from sensor</p>
</section>
<section id="signal-filtering">
<h3>4.6 Signal filtering<a class="headerlink" href="#signal-filtering" title="Link to this heading"></a></h3>
<p>The SMI240 offers two filters (400Hz and 50Hz) which are configurable by the user</p>
<p>check available ACC filter option</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="n">in_accel_filter_low_pass_3db_frequency_available</span>
<span class="mi">50</span> <span class="mi">400</span>
</pre></div>
</div>
<p>check available GYR filter option</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="n">in_anglvel_filter_low_pass_3db_frequency_available</span>
<span class="mi">50</span> <span class="mi">400</span>
</pre></div>
</div>
<p>check current ACC filter option</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="n">in_accel_filter_low_pass_3db_frequency</span>
<span class="mi">400</span>
</pre></div>
</div>
<p>Make sure that you have root access. if not using “sudo su”</p>
<p>set ACC filter</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="mi">50</span> <span class="o">&gt;</span> <span class="n">in_accel_filter_low_pass_3db_frequency</span>
<span class="n">cat</span> <span class="n">in_accel_filter_low_pass_3db_frequency</span>
<span class="mi">50</span>
</pre></div>
</div>
<p>check current GYR filter option</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="n">in_anglvel_filter_low_pass_3db_frequency</span>
<span class="mi">400</span>
</pre></div>
</div>
<p>set GYR filter</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="mi">50</span> <span class="o">&gt;</span> <span class="n">in_anglvel_filter_low_pass_3db_frequency</span>
<span class="n">cat</span> <span class="n">in_anglvel_filter_low_pass_3db_frequency</span>
<span class="mi">50</span>
</pre></div>
</div>
</section>
<section id="self-test">
<h3>4.7 Self Test<a class="headerlink" href="#self-test" title="Link to this heading"></a></h3>
<p>The sensor module provides an electro-mechanical self-test (BITE) which is bidirectional, deflecting the sensing element in positive and negative measurement direction. The BITE tests verifies the functionality of the MEMS elements and ASIC signal path. User can define BITE repetitions between 1 and 8.</p>
<p>check current BITE repetitions</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="n">bite_repetitions</span>
<span class="mi">3</span>
</pre></div>
</div>
<p>set BITE repetitions</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="mi">8</span> <span class="o">&gt;</span> <span class="n">bite_repetitions</span>
<span class="n">cat</span> <span class="n">bite_repetitions</span>
<span class="mi">8</span>
</pre></div>
</div>
<p>start self test</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="n">self_test</span>
<span class="bp">self</span> <span class="n">test</span> <span class="n">success</span><span class="o">.</span>
</pre></div>
</div>
</section>
<section id="soft-reset">
<h3>4.8 Soft reset<a class="headerlink" href="#soft-reset" title="Link to this heading"></a></h3>
<p>trigger soft reset</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="n">soft_reset</span>
<span class="n">soft</span> <span class="n">reset</span> <span class="n">performed</span><span class="o">.</span>
</pre></div>
</div>
</section>
<section id="sign-of-channels">
<h3>4.9 Sign of channels<a class="headerlink" href="#sign-of-channels" title="Link to this heading"></a></h3>
<p>User is able to invert the sign of each ACC/GYR channel.</p>
<p>check current sign of channels</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="n">sign_of_channels</span>
<span class="n">ax</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="n">ay</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="n">az</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="n">gx</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="n">gy</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="n">gz</span><span class="p">:</span><span class="mi">0</span>
</pre></div>
</div>
<p>“ax:0” -&gt; sign of accel x axis is normal (not inverted)</p>
<p>invert sign of one singel channel</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="n">ay</span><span class="p">:</span><span class="mi">1</span> <span class="o">&gt;</span> <span class="n">sign_of_channels</span>
<span class="n">cat</span> <span class="n">sign_of_channels</span>
<span class="n">ax</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="n">ay</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="n">az</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="n">gx</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="n">gy</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="n">gz</span><span class="p">:</span><span class="mi">0</span>
</pre></div>
</div>
<p>“echo ay:1” -&gt; invert sign of accel y axis</p>
<p>clear the sign inversion for one singel channel</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="n">ay</span><span class="p">:</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">sign_of_channels</span>
<span class="n">cat</span> <span class="n">sign_of_channels</span>
<span class="n">ax</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="n">ay</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="n">az</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="n">gx</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="n">gy</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="n">gz</span><span class="p">:</span><span class="mi">0</span>
</pre></div>
</div>
<p>“echo ay:0” -&gt; clear sign inversion of accel y axis</p>
<p>invert sign of several channels (up to 6) at once</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="n">az</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="n">gx</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="n">gy</span><span class="p">:</span><span class="mi">1</span> <span class="o">&gt;</span> <span class="n">sign_of_channels</span>
<span class="n">cat</span> <span class="n">sign_of_channels</span>
<span class="n">ax</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="n">ay</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="n">az</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="n">gx</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="n">gy</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="n">gz</span><span class="p">:</span><span class="mi">0</span>
</pre></div>
</div>
<p>clear the sign inversion of several channels (up to 6) at once</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="n">ax</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="n">ay</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="n">az</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="n">gx</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="n">gy</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="n">gz</span><span class="p">:</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">sign_of_channels</span>
<span class="n">cat</span> <span class="n">sign_of_channels</span>
<span class="n">ax</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="n">ay</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="n">az</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="n">gx</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="n">gy</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="n">gz</span><span class="p">:</span><span class="mi">0</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="bosch_smi230_IIO.html" class="btn btn-neutral float-left" title="Bosch SMI230 IIO driver" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="bosch_smi330_IIO.html" class="btn btn-neutral float-right" title="Bosch SMI330 IIO driver" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Robert Bosch GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>